name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Scaleway Container Registry
      run: echo ${{ secrets.SCW_SECRET_KEY}} | docker login rg.fr-par.scw.cloud/atut-group-1 -u ${{secrets.SCW_SECRET_KEY}} --password-stdin


    - name: Extract Commit Hash
      id: get_commit
      run: echo "COMMIT_HASH=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_ENV

    - name: Build and Push Backend Docker Image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --build-arg COMMIT_HASH=${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-backend:${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/backend:latest \
          --push \
          ./backend

    - name: Build and Push Frontend Docker Image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --build-arg COMMIT_HASH=${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-frontend:${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/frontend:latest \
          --push \
          ./frontend

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Execute Deployment Script on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          #!/bin/bash
          COMMIT_HASH=${{ env.COMMIT_HASH }}
          mkdir -p ~/app/$COMMIT_HASH
          cd ~/app/$COMMIT_HASH
          echo 'cat << EOF > docker-compose.yml' >> ~/deploy.sh
          echo 'services:' >> ~/deploy.sh
          echo '  api:' >> ~/deploy.sh
          echo '    image: rg.fr-par.scw.cloud/atut-group-1/hash-test-backend:${{ env.COMMIT_HASH }}' >> ~/deploy.sh
          echo '    ports:' >> ~/deploy.sh
          echo '      - "8000:8000"' >> ~/deploy.sh
          echo '    volumes:' >> ~/deploy.sh
          echo '      - ./backend:/backend' >> ~/deploy.sh
          echo '    container_name: api' >> ~/deploy.sh
          echo '    networks:' >> ~/deploy.sh
          echo '      - app_network' >> ~/deploy.sh
          echo '    restart: always' >> ~/deploy.sh
          echo '' >> ~/deploy.sh
          echo '  app:' >> ~/deploy.sh
          echo '    image: rg.fr-par.scw.cloud/atut-group-1/hash-test-frontend:${{ env.COMMIT_HASH }}' >> ~/deploy.sh
          echo '    ports:' >> ~/deploy.sh
          echo '      - "8501:8501"' >> ~/deploy.sh
          echo '    volumes:' >> ~/deploy.sh
          echo '      - ./frontend:/frontend' >> ~/deploy.sh
          echo '    container_name: frontend' >> ~/deploy.sh
          echo '    networks:' >> ~/deploy.sh
          echo '      - app_network' >> ~/deploy.sh
          echo '    restart: always' >> ~/deploy.sh
          echo '' >> ~/deploy.sh
          echo 'networks:' >> ~/deploy.sh
          echo '  app_network:' >> ~/deploy.sh
          echo '    driver: bridge' >> ~/deploy.sh
          echo 'EOF' >> ~/deploy.sh
          echo 'chmod +x ~/deploy.sh' >> ~/deploy.sh
          echo '~/deploy.sh' >> ~/deploy.sh
          chmod +x ~/deploy.sh
          ~/deploy.sh
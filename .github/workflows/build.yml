name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Scaleway Container Registry
      run: echo ${{ secrets.SCW_SECRET_KEY}} | docker login rg.fr-par.scw.cloud/atut-group-1 -u ${{secrets.SCW_SECRET_KEY}} --password-stdin


    - name: Extract Commit Hash
      id: get_commit
      run: echo "COMMIT_HASH=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_ENV

    - name: Build and Push Backend Docker Image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --build-arg COMMIT_HASH=${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-backend:${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-backend:latest \
          --push \
          ./backend

    - name: Build and Push Frontend Docker Image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --build-arg COMMIT_HASH=${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-frontend:${{ env.COMMIT_HASH }} \
          -t rg.fr-par.scw.cloud/atut-group-1/hash-test-frontend:latest \
          --push \
          ./frontend

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Execute Deployment Script on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          COMMIT_HASH=${{ env.COMMIT_HASH }}
          mkdir -p /app/$COMMIT_HASH
          cd /app/$COMMIT_HASH
          
          cat <<EOF > deploy.sh
            #!/bin/bash
            mkdir -p /app/$COMMIT_HASH
            cd /app/$COMMIT_HASH
            cat << EOL > docker-compose.yml
            services:
              api:
                image: rg.fr-par.scw.cloud/atut-group-1/hash-test-backend:${{ env.COMMIT_HASH }}
                ports:
                  - "8000:8000"
                volumes:
                  - ./backend:/backend
                container_name: api
                networks:
                  - app_network
                restart: always

              app:
                image: rg.fr-par.scw.cloud/atut-group-1/hash-test-frontend:${{ env.COMMIT_HASH }}
                ports:
                  - "8501:8501"
                volumes:
                  - ./frontend:/frontend
                container_name: frontend
                networks:
                  - app_network
                restart: always

            networks:
              app_network:
                driver: bridge
            EOL
          EOF
          chmod +x deploy.sh
          ./deploy.sh